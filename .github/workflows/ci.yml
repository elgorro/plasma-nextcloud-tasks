name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    container: fedora:latest

    steps:
      - name: Install dependencies
        run: |
          dnf install -y \
            cmake \
            extra-cmake-modules \
            gcc-c++ \
            gettext-devel \
            git \
            kf6-ki18n-devel \
            libplasma-devel \
            qt6-qtbase-devel \
            qt6-qtdeclarative-devel \
            zip

      - uses: actions/checkout@v4

      - name: Configure
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Install
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: DESTDIR=$GITHUB_WORKSPACE/install cmake --build build --target install

      - name: Create .plasmoid archive
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          PLASMOID_DIR="$GITHUB_WORKSPACE/install/usr/share/plasma/plasmoids/com.github.elgorro.nextcloud-tasks"
          QML_DIR=$(find "$GITHUB_WORKSPACE/install" -type d -path "*/com/github/elgorro/nextcloudtasks" | head -1)

          # Bundle the compiled plugin into the plasmoid
          mkdir -p "$PLASMOID_DIR/contents/plugin"
          cp "$QML_DIR"/libnextcloudtasksplugin.so "$PLASMOID_DIR/contents/plugin/"
          cp "$QML_DIR"/nextcloudtaskspluginplugin.so "$PLASMOID_DIR/contents/plugin/" 2>/dev/null || true
          cp "$QML_DIR"/qmldir "$PLASMOID_DIR/contents/plugin/"
          cp "$QML_DIR"/nextcloudtasksplugin.qmltypes "$PLASMOID_DIR/contents/plugin/" 2>/dev/null || true

          cd "$PLASMOID_DIR"
          zip -r "$GITHUB_WORKSPACE/com.github.elgorro.nextcloud-tasks.plasmoid" .

      - name: Create source tarball
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          VERSION=$(python3 -c "import json; print(json.load(open('package/metadata.json'))['KPlugin']['Version'])")
          git archive --format=tar.gz --prefix=plasma-nextcloud-tasks-${VERSION}/ HEAD \
            -o $GITHUB_WORKSPACE/plasma-nextcloud-tasks-${VERSION}.tar.gz

      - name: Upload .plasmoid artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: plasmoid
          path: ${{ github.workspace }}/com.github.elgorro.nextcloud-tasks.plasmoid

      - name: Upload source tarball artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: ${{ github.workspace }}/plasma-nextcloud-tasks-*.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: release
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: plasmoid

      - uses: actions/download-artifact@v4
        with:
          name: source-tarball

      - name: Read version and create release
        run: |
          VERSION=$(jq -r '.KPlugin.Version' package/metadata.json)
          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --generate-notes \
            com.github.elgorro.nextcloud-tasks.plasmoid \
            plasma-nextcloud-tasks-*.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
